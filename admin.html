<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - JAPANVARIETY PRIVATE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-card: #242424;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --accent: #f59e0b;
      --accent-hover: #fbbf24;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      --info: #3b82f6;
      --border: #333333;
    }

    body {
      font-family: 'IBM Plex Sans Thai', 'Space Grotesk', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .logo img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .logo-text {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.5px;
    }

    .logo-sub {
      font-size: 10px;
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .nav-menu {
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
      color: var(--text-secondary);
      text-decoration: none;
    }

    .nav-item:hover, .nav-item.active {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .nav-item.active {
      border-left: 3px solid var(--accent);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
    }

    /* Main Content */
    .main-content {
      margin-left: 260px;
      padding: 24px;
      min-height: 100vh;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    /* Data Table */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 16px 24px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    tr:hover {
      background: rgba(255,255,255,0.02);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-inquiry { background: rgba(59, 130, 246, 0.2); color: var(--info); }
    .status-confirmed { background: rgba(245, 158, 11, 0.2); color: var(--accent); }
    .status-paid { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .status-completed { background: rgba(34, 197, 94, 0.3); color: var(--success); }
    .status-cancelled { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .status-deposit { background: rgba(59, 130, 246, 0.2); color: var(--info); }
    .status-partial { background: rgba(245, 158, 11, 0.2); color: var(--accent); }
    .status-full { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .status-refund { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    
    /* Car booking status */
    .status-charter { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
    .status-transfer { background: rgba(14, 165, 233, 0.2); color: #38bdf8; }
    .status-disposal { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
    .status-pending { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
    .status-quoted { background: rgba(245, 158, 11, 0.2); color: var(--accent); }

    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 8px;
    }

    .action-btn:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 10px;
      width: fit-content;
    }

    .tab {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--accent);
      color: #000;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        margin-left: 0;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <img src="./logo/japan-variety-logo-1.png" alt="Logo">
      <div>
        <div class="logo-text">JAPANVARIETY</div>
        <div class="logo-sub">Admin Panel</div>
      </div>
    </div>
    
    <nav class="nav-menu">
      <a href="#dashboard" class="nav-item active" data-section="dashboard">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Dashboard
      </a>
      <a href="#customers" class="nav-item" data-section="customers">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        ลูกค้า
      </a>
      <a href="#bookings" class="nav-item" data-section="bookings">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        การจอง
      </a>
      <a href="#car-companies" class="nav-item" data-section="car-companies">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
        บริษัทรถ
      </a>
      <a href="#payments" class="nav-item" data-section="payments">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        การชำระเงิน
      </a>
      <a href="#car-bookings" class="nav-item" data-section="car-bookings">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        จองรถรายวัน
      </a>
    </nav>

    <a href="/" class="nav-item" style="margin-top: auto;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
      กลับหน้าหลัก
    </a>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard Section -->
    <section id="section-dashboard" class="section">
      <div class="header">
        <h1 class="page-title">Dashboard</h1>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="loadDashboard()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            รีเฟรช
          </button>
        </div>
      </div>

      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ลูกค้าทั้งหมด</div>
          <div class="stat-value" id="stat-customers">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">การจองทั้งหมด</div>
          <div class="stat-value" id="stat-bookings">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">รอชำระเงิน</div>
          <div class="stat-value" id="stat-pending">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">รายได้ (THB)</div>
          <div class="stat-value" id="stat-revenue">-</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">การจองล่าสุด</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>รหัสจอง</th>
                <th>ลูกค้า</th>
                <th>วันเดินทาง</th>
                <th>สถานะ</th>
                <th>ราคา</th>
              </tr>
            </thead>
            <tbody id="recent-bookings">
              <tr><td colspan="5" class="loading"><div class="spinner"></div> กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Customers Section -->
    <section id="section-customers" class="section" style="display:none;">
      <div class="header">
        <h1 class="page-title">ลูกค้า</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openCustomerModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            เพิ่มลูกค้า
          </button>
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ชื่อ</th>
                <th>โทรศัพท์</th>
                <th>อีเมล</th>
                <th>LINE</th>
                <th>แหล่งที่มา</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="customers-table">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Bookings Section -->
    <section id="section-bookings" class="section" style="display:none;">
      <div class="header">
        <h1 class="page-title">การจอง</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openBookingModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            สร้างการจอง
          </button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-status="all">ทั้งหมด</div>
        <div class="tab" data-status="inquiry">สอบถาม</div>
        <div class="tab" data-status="confirmed">ยืนยันแล้ว</div>
        <div class="tab" data-status="paid">ชำระแล้ว</div>
        <div class="tab" data-status="completed">เสร็จสิ้น</div>
      </div>

      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>รหัสจอง</th>
                <th>ลูกค้า</th>
                <th>วันเดินทาง</th>
                <th>ราคา</th>
                <th>ชำระแล้ว</th>
                <th>คงเหลือ</th>
                <th>กำหนดชำระ</th>
                <th>สถานะ</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="bookings-table">
              <tr><td colspan="9" class="loading"><div class="spinner"></div> กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Car Companies Section -->
    <section id="section-car-companies" class="section" style="display:none;">
      <div class="header">
        <h1 class="page-title">บริษัทรถ</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openCarCompanyModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            เพิ่มบริษัทรถ
          </button>
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ชื่อบริษัท</th>
                <th>ผู้ติดต่อ</th>
                <th>โทรศัพท์</th>
                <th>LINE</th>
                <th>โซนให้บริการ</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="car-companies-table">
              <tr><td colspan="6" class="loading"><div class="spinner"></div> กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Payments Section -->
    <section id="section-payments" class="section" style="display:none;">
      <div class="header">
        <h1 class="page-title">การชำระเงิน</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openPaymentModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            บันทึกการชำระเงิน
          </button>
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>รหัสจอง</th>
                <th>ลูกค้า</th>
                <th>ประเภท</th>
                <th>จำนวนเงิน</th>
                <th>วิธีชำระ</th>
                <th>วันที่ชำระ</th>
                <th>สลิป</th>
                <th>สถานะ</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="payments-table">
              <tr><td colspan="9" class="loading"><div class="spinner"></div> กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Car Bookings Section -->
    <section id="section-car-bookings" class="section" style="display:none;">
      <div class="header">
        <h1 class="page-title">จองรถรายวัน</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openCarBookingModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            เพิ่มรายการจองรถ
          </button>
        </div>
      </div>

      <!-- Filter by Booking -->
      <div class="card" style="margin-bottom:20px;padding:16px;">
        <div class="form-row" style="align-items:flex-end;">
          <div class="form-group" style="margin-bottom:0;flex:1;">
            <label class="form-label">กรองตาม Booking</label>
            <select class="form-input" id="car-booking-filter" onchange="filterCarBookings()">
              <option value="">-- แสดงทั้งหมด --</option>
            </select>
          </div>
          <button class="btn btn-secondary" onclick="loadCarBookings()">รีเฟรช</button>
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>รหัสจอง</th>
                <th>วันที่</th>
                <th>ประเภท</th>
                <th>รถ</th>
                <th>เวลา/สถานที่</th>
                <th>บริษัทรถ</th>
                <th>ราคา</th>
                <th>สถานะ</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="car-bookings-table">
              <tr><td colspan="9" class="loading"><div class="spinner"></div> กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Summary Card -->
      <div class="card" style="margin-top:20px;padding:20px;" id="car-booking-summary" style="display:none;">
        <h3 style="margin-bottom:12px;">สรุปค่ารถ</h3>
        <div id="car-booking-summary-content"></div>
      </div>
    </section>
  </main>

  <!-- Customer Modal -->
  <div class="modal-overlay" id="customer-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="customer-modal-title">เพิ่มลูกค้าใหม่</h3>
        <button class="modal-close" onclick="closeModal('customer-modal')">&times;</button>
      </div>
      <form id="customer-form" onsubmit="saveCustomer(event)">
        <div class="modal-body">
          <input type="hidden" id="customer-id">
          <div class="form-group">
            <label class="form-label">ชื่อ *</label>
            <input type="text" class="form-input" id="customer-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">โทรศัพท์</label>
              <input type="text" class="form-input" id="customer-phone">
            </div>
            <div class="form-group">
              <label class="form-label">อีเมล</label>
              <input type="email" class="form-input" id="customer-email">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">LINE Display Name</label>
            <input type="text" class="form-input" id="customer-line">
          </div>
          <div class="form-group">
            <label class="form-label">แหล่งที่มา</label>
            <select class="form-input" id="customer-source">
              <option value="">-- เลือก --</option>
              <option value="Facebook">Facebook</option>
              <option value="Instagram">Instagram</option>
              <option value="LINE">LINE</option>
              <option value="Website">Website</option>
              <option value="Referral">แนะนำจากลูกค้า</option>
              <option value="Other">อื่นๆ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-input" id="customer-notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('customer-modal')">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Booking Modal -->
  <div class="modal-overlay" id="booking-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="booking-modal-title">สร้างการจองใหม่</h3>
        <button class="modal-close" onclick="closeModal('booking-modal')">&times;</button>
      </div>
      <form id="booking-form" onsubmit="saveBooking(event)">
        <div class="modal-body">
          <input type="hidden" id="booking-id">
          <div class="form-group">
            <label class="form-label">ลูกค้า *</label>
            <select class="form-input" id="booking-customer" required>
              <option value="">-- เลือกลูกค้า --</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">วันเริ่มเดินทาง *</label>
              <input type="date" class="form-input" id="booking-start" required>
            </div>
            <div class="form-group">
              <label class="form-label">วันจบเดินทาง *</label>
              <input type="date" class="form-input" id="booking-end" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">โซน</label>
            <select class="form-input" id="booking-region">
              <option value="">-- เลือก --</option>
              <option value="Kanto">Kanto (โตเกียว)</option>
              <option value="Kansai">Kansai (โอซาก้า/เกียวโต)</option>
              <option value="Hokkaido">Hokkaido</option>
              <option value="Chubu">Chubu (นาโกย่า)</option>
              <option value="Kyushu">Kyushu</option>
              <option value="Multi">หลายโซน</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ผู้ใหญ่</label>
              <input type="number" class="form-input" id="booking-adults" min="0" value="2">
            </div>
            <div class="form-group">
              <label class="form-label">เด็ก</label>
              <input type="number" class="form-input" id="booking-children" min="0" value="0">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ราคารวม</label>
              <input type="number" class="form-input" id="booking-price" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">สถานะ</label>
              <select class="form-input" id="booking-status">
                <option value="inquiry">สอบถาม</option>
                <option value="confirmed">ยืนยันแล้ว</option>
                <option value="paid">ชำระแล้ว</option>
                <option value="completed">เสร็จสิ้น</option>
                <option value="cancelled">ยกเลิก</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Quotation / เส้นทาง (สำหรับ บ.รถ)</label>
            <textarea class="form-input" id="booking-quotation" rows="8" placeholder="วาง Quotation หรือรายละเอียดเส้นทางที่ส่งให้ บ.รถ ที่นี่..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">กำหนดชำระงวดถัดไป</label>
              <input type="date" class="form-input" id="booking-next-due">
            </div>
            <div class="form-group">
              <label class="form-label">ยอดงวดถัดไป</label>
              <input type="number" class="form-input" id="booking-next-amount" min="0" placeholder="จำนวนเงิน">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-input" id="booking-notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('booking-modal')">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Car Company Modal -->
  <div class="modal-overlay" id="car-company-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">เพิ่มบริษัทรถ</h3>
        <button class="modal-close" onclick="closeModal('car-company-modal')">&times;</button>
      </div>
      <form id="car-company-form" onsubmit="saveCarCompany(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">ชื่อบริษัท *</label>
            <input type="text" class="form-input" id="company-name" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ผู้ติดต่อ</label>
              <input type="text" class="form-input" id="company-contact">
            </div>
            <div class="form-group">
              <label class="form-label">โทรศัพท์</label>
              <input type="text" class="form-input" id="company-phone">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">อีเมล</label>
              <input type="email" class="form-input" id="company-email">
            </div>
            <div class="form-group">
              <label class="form-label">LINE ID</label>
              <input type="text" class="form-input" id="company-line">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-input" id="company-notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('car-company-modal')">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal-overlay" id="payment-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="payment-modal-title">บันทึกการชำระเงิน</h3>
        <button class="modal-close" onclick="closeModal('payment-modal')">&times;</button>
      </div>
      <form id="payment-form" onsubmit="savePayment(event)">
        <div class="modal-body">
          <input type="hidden" id="payment-id">
          <div class="form-group">
            <label class="form-label">การจอง *</label>
            <select class="form-input" id="payment-booking" required>
              <option value="">-- เลือกการจอง --</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ประเภทการชำระ *</label>
              <select class="form-input" id="payment-type" required>
                <option value="deposit">มัดจำ</option>
                <option value="partial">ชำระบางส่วน</option>
                <option value="full">ชำระเต็มจำนวน</option>
                <option value="refund">คืนเงิน</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">จำนวนเงิน *</label>
              <input type="number" class="form-input" id="payment-amount" min="0" step="0.01" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">สกุลเงิน</label>
              <select class="form-input" id="payment-currency">
                <option value="THB">THB (บาท)</option>
                <option value="JPY">JPY (เยน)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">วิธีชำระ</label>
              <select class="form-input" id="payment-method">
                <option value="">-- เลือก --</option>
                <option value="transfer">โอนเงิน</option>
                <option value="cash">เงินสด</option>
                <option value="credit">บัตรเครดิต</option>
                <option value="promptpay">PromptPay</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">วันที่ชำระ</label>
              <input type="date" class="form-input" id="payment-date">
            </div>
            <div class="form-group">
              <label class="form-label">เลขอ้างอิง</label>
              <input type="text" class="form-input" id="payment-reference" placeholder="เลขที่โอน/Ref">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">อัพโหลดสลิป</label>
            <input type="file" class="form-input" id="payment-slip" accept="image/*,.pdf" onchange="previewSlip(this)">
            <div id="slip-preview" style="margin-top:10px;"></div>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-input" id="payment-notes" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('payment-modal')">ยกเลิก</button>
          <button type="submit" class="btn btn-primary" id="payment-submit-btn">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Car Booking Modal -->
  <div class="modal-overlay" id="car-booking-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="car-booking-modal-title">เพิ่มรายการจองรถ</h3>
        <button class="modal-close" onclick="closeModal('car-booking-modal')">&times;</button>
      </div>
      <form id="car-booking-form" onsubmit="saveCarBooking(event)">
        <div class="modal-body">
          <input type="hidden" id="car-booking-id">
          <div class="form-group">
            <label class="form-label">การจอง *</label>
            <select class="form-input" id="car-booking-booking" required>
              <option value="">-- เลือกการจอง --</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">วันที่ใช้บริการ *</label>
              <input type="date" class="form-input" id="car-booking-date" required>
            </div>
            <div class="form-group">
              <label class="form-label">ประเภทบริการ *</label>
              <select class="form-input" id="car-booking-type" required>
                <option value="Charter">Charter 10 ชม.</option>
                <option value="Transfer">Transfer</option>
                <option value="Disposal">Disposal</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ประเภทรถ</label>
              <select class="form-input" id="car-booking-vehicle">
                <option value="">-- เลือก --</option>
                <option value="Alphard">Toyota Alphard</option>
                <option value="Hiace">Toyota Hiace Grand Cabin</option>
                <option value="Coaster">Toyota Coaster</option>
                <option value="Other">อื่นๆ</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">บริษัทรถ</label>
              <select class="form-input" id="car-booking-company">
                <option value="">-- เลือก --</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">เวลารับ</label>
              <input type="time" class="form-input" id="car-booking-pickup-time">
            </div>
            <div class="form-group">
              <label class="form-label">สถานที่รับ</label>
              <input type="text" class="form-input" id="car-booking-pickup-loc" placeholder="เช่น Haneda Airport">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">สถานที่ส่ง</label>
            <input type="text" class="form-input" id="car-booking-dropoff-loc" placeholder="เช่น Hotel in Shinjuku">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ราคาเสนอ</label>
              <input type="number" class="form-input" id="car-booking-quoted" min="0" placeholder="ราคาที่ บ.รถ เสนอ">
            </div>
            <div class="form-group">
              <label class="form-label">ราคาตกลง</label>
              <input type="number" class="form-input" id="car-booking-confirmed" min="0" placeholder="ราคาที่ตกลงกัน">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ชื่อคนขับ</label>
              <input type="text" class="form-input" id="car-booking-driver-name">
            </div>
            <div class="form-group">
              <label class="form-label">เบอร์คนขับ</label>
              <input type="text" class="form-input" id="car-booking-driver-phone">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">สถานะ</label>
            <select class="form-input" id="car-booking-status">
              <option value="pending">รอยืนยัน</option>
              <option value="quoted">ได้ราคาแล้ว</option>
              <option value="confirmed">ยืนยันแล้ว</option>
              <option value="completed">เสร็จสิ้น</option>
              <option value="cancelled">ยกเลิก</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">หมายเหตุ</label>
            <textarea class="form-input" id="car-booking-notes" rows="2" placeholder="รายละเอียดเพิ่มเติม เช่น จุดแวะ, ของที่ต้องเตรียม"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('car-booking-modal')">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let customersData = [];
    let bookingsData = [];
    let carCompaniesData = [];
    let paymentsData = [];
    let uploadedSlipUrl = null;

    // Navigation
    document.querySelectorAll('.nav-item[data-section]').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const section = item.dataset.section;
        showSection(section);
      });
    });

    function showSection(section) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(`section-${section}`).style.display = 'block';
      document.querySelector(`.nav-item[data-section="${section}"]`).classList.add('active');
      
      // Load data for section
      if (section === 'dashboard') loadDashboard();
      if (section === 'customers') loadCustomers();
      if (section === 'bookings') loadBookings();
      if (section === 'car-companies') loadCarCompanies();
      if (section === 'payments') loadPayments();
      if (section === 'car-bookings') loadCarBookings();
    }

    // API Calls
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
      };
      if (body) options.body = JSON.stringify(body);
      
      const res = await fetch(`${API_BASE}${endpoint}`, options);
      return res.json();
    }

    // Dashboard
    async function loadDashboard() {
      try {
        const data = await apiCall('/dashboard');
        if (data.success) {
          document.getElementById('stat-customers').textContent = data.data.customers.total;
          document.getElementById('stat-bookings').textContent = data.data.bookings.total;
          document.getElementById('stat-pending').textContent = data.data.bookings.inquiry + data.data.bookings.confirmed;
          document.getElementById('stat-revenue').textContent = formatCurrency(data.data.revenue.thb);
          
          renderRecentBookings(data.data.recentBookings);
        }
      } catch (err) {
        console.error('Error loading dashboard:', err);
      }
    }

    function renderRecentBookings(bookings) {
      const tbody = document.getElementById('recent-bookings');
      if (!bookings || bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ยังไม่มีการจอง</td></tr>';
        return;
      }
      
      tbody.innerHTML = bookings.map(b => `
        <tr>
          <td><strong>${b.booking_code}</strong></td>
          <td>${b.customer_name || '-'}</td>
          <td>${formatDate(b.travel_start_date)} - ${formatDate(b.travel_end_date)}</td>
          <td><span class="status-badge status-${b.status}">${getStatusText(b.status)}</span></td>
          <td>${b.total_price ? formatCurrency(b.total_price) + ' ' + (b.currency || 'THB') : '-'}</td>
        </tr>
      `).join('');
    }

    // Customers
    async function loadCustomers() {
      try {
        const data = await apiCall('/customers');
        if (data.success) {
          customersData = data.data;
          renderCustomers();
        }
      } catch (err) {
        console.error('Error loading customers:', err);
      }
    }

    function renderCustomers() {
      const tbody = document.getElementById('customers-table');
      if (customersData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ยังไม่มีลูกค้า</td></tr>';
        return;
      }
      
      tbody.innerHTML = customersData.map(c => `
        <tr>
          <td><strong>${c.name}</strong></td>
          <td>${c.phone || '-'}</td>
          <td>${c.email || '-'}</td>
          <td>${c.line_display_name || '-'}</td>
          <td>${c.source || '-'}</td>
          <td>
            <button class="action-btn" onclick="editCustomer(${c.id})">แก้ไข</button>
            <button class="action-btn" onclick="deleteCustomer(${c.id})">ลบ</button>
          </td>
        </tr>
      `).join('');
    }

    function openCustomerModal(customer = null) {
      document.getElementById('customer-modal-title').textContent = customer ? 'แก้ไขลูกค้า' : 'เพิ่มลูกค้าใหม่';
      document.getElementById('customer-id').value = customer?.id || '';
      document.getElementById('customer-name').value = customer?.name || '';
      document.getElementById('customer-phone').value = customer?.phone || '';
      document.getElementById('customer-email').value = customer?.email || '';
      document.getElementById('customer-line').value = customer?.line_display_name || '';
      document.getElementById('customer-source').value = customer?.source || '';
      document.getElementById('customer-notes').value = customer?.notes || '';
      document.getElementById('customer-modal').classList.add('active');
    }

    function editCustomer(id) {
      const customer = customersData.find(c => c.id === id);
      if (customer) openCustomerModal(customer);
    }

    async function saveCustomer(e) {
      e.preventDefault();
      const id = document.getElementById('customer-id').value;
      const data = {
        name: document.getElementById('customer-name').value,
        phone: document.getElementById('customer-phone').value,
        email: document.getElementById('customer-email').value,
        line_display_name: document.getElementById('customer-line').value,
        source: document.getElementById('customer-source').value,
        notes: document.getElementById('customer-notes').value
      };
      
      try {
        if (id) {
          await apiCall(`/customers/${id}`, 'PUT', data);
        } else {
          await apiCall('/customers', 'POST', data);
        }
        closeModal('customer-modal');
        loadCustomers();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    async function deleteCustomer(id) {
      if (!confirm('ต้องการลบลูกค้านี้?')) return;
      try {
        await apiCall(`/customers/${id}`, 'DELETE');
        loadCustomers();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    // Bookings
    async function loadBookings() {
      try {
        const data = await apiCall('/bookings');
        if (data.success) {
          bookingsData = data.data;
          renderBookings();
        }
      } catch (err) {
        console.error('Error loading bookings:', err);
      }
    }

    function renderBookings(filter = 'all') {
      const tbody = document.getElementById('bookings-table');
      let filtered = filter === 'all' ? bookingsData : bookingsData.filter(b => b.status === filter);
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ไม่มีการจอง</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(b => {
        const totalPrice = b.total_price || 0;
        const totalPaid = b.total_paid || 0;
        const remaining = b.remaining_amount || 0;
        const isOverdue = b.next_payment_due && new Date(b.next_payment_due) < new Date();
        
        return `
        <tr>
          <td><strong>${b.booking_code}</strong></td>
          <td>${b.customer_name || '-'}</td>
          <td>${formatDate(b.travel_start_date)} - ${formatDate(b.travel_end_date)}</td>
          <td>${totalPrice ? formatCurrency(totalPrice) + ' ' + (b.currency || 'THB') : '-'}</td>
          <td style="color:var(--success)">${totalPaid > 0 ? formatCurrency(totalPaid) : '-'}</td>
          <td style="color:${remaining > 0 ? 'var(--warning)' : 'var(--success)'}">${remaining > 0 ? formatCurrency(remaining) : (totalPrice > 0 ? '✓ ครบ' : '-')}</td>
          <td style="color:${isOverdue ? 'var(--danger)' : 'inherit'}">${b.next_payment_due ? formatDate(b.next_payment_due) + (b.next_payment_amount ? '<br><small>' + formatCurrency(b.next_payment_amount) + '</small>' : '') : '-'}</td>
          <td><span class="status-badge status-${b.status}">${getStatusText(b.status)}</span></td>
          <td>
            <button class="action-btn" onclick="editBooking(${b.id})">แก้ไข</button>
            <button class="action-btn" onclick="openPaymentModalForBooking(${b.id})">💰</button>
            <button class="action-btn" onclick="deleteBooking(${b.id})">ลบ</button>
          </td>
        </tr>
      `}).join('');
    }

    // Tab filtering
    document.querySelectorAll('.tabs .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderBookings(tab.dataset.status);
      });
    });

    async function openBookingModal(booking = null) {
      // Load customers for dropdown
      if (customersData.length === 0) {
        const data = await apiCall('/customers');
        if (data.success) customersData = data.data;
      }
      
      const select = document.getElementById('booking-customer');
      select.innerHTML = '<option value="">-- เลือกลูกค้า --</option>' + 
        customersData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      
      document.getElementById('booking-modal-title').textContent = booking ? 'แก้ไขการจอง' : 'สร้างการจองใหม่';
      document.getElementById('booking-id').value = booking?.id || '';
      document.getElementById('booking-customer').value = booking?.customer_id || '';
      document.getElementById('booking-start').value = booking?.travel_start_date || '';
      document.getElementById('booking-end').value = booking?.travel_end_date || '';
      document.getElementById('booking-region').value = booking?.region || '';
      document.getElementById('booking-adults').value = booking?.pax_adults || 2;
      document.getElementById('booking-children').value = booking?.pax_children || 0;
      document.getElementById('booking-price').value = booking?.total_price || '';
      document.getElementById('booking-status').value = booking?.status || 'inquiry';
      document.getElementById('booking-quotation').value = booking?.route_quotation || '';
      document.getElementById('booking-next-due').value = booking?.next_payment_due || '';
      document.getElementById('booking-next-amount').value = booking?.next_payment_amount || '';
      document.getElementById('booking-notes').value = booking?.notes || '';
      document.getElementById('booking-modal').classList.add('active');
    }

    // Open payment modal pre-filled for a booking
    async function openPaymentModalForBooking(bookingId) {
      const booking = bookingsData.find(b => b.id === bookingId);
      if (booking) {
        await openPaymentModal();
        document.getElementById('payment-booking').value = bookingId;
        // Pre-fill remaining amount if available
        if (booking.remaining_amount > 0) {
          document.getElementById('payment-amount').value = booking.remaining_amount;
        }
      }
    }

    function editBooking(id) {
      const booking = bookingsData.find(b => b.id === id);
      if (booking) openBookingModal(booking);
    }

    async function saveBooking(e) {
      e.preventDefault();
      const id = document.getElementById('booking-id').value;
      const data = {
        customer_id: parseInt(document.getElementById('booking-customer').value),
        travel_start_date: document.getElementById('booking-start').value,
        travel_end_date: document.getElementById('booking-end').value,
        region: document.getElementById('booking-region').value,
        pax_adults: parseInt(document.getElementById('booking-adults').value) || 0,
        pax_children: parseInt(document.getElementById('booking-children').value) || 0,
        total_price: parseFloat(document.getElementById('booking-price').value) || null,
        status: document.getElementById('booking-status').value,
        route_quotation: document.getElementById('booking-quotation').value,
        next_payment_due: document.getElementById('booking-next-due').value || null,
        next_payment_amount: parseFloat(document.getElementById('booking-next-amount').value) || null,
        notes: document.getElementById('booking-notes').value
      };
      
      try {
        if (id) {
          await apiCall(`/bookings/${id}`, 'PUT', data);
        } else {
          await apiCall('/bookings', 'POST', data);
        }
        closeModal('booking-modal');
        loadBookings();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    async function deleteBooking(id) {
      if (!confirm('ต้องการลบการจองนี้?')) return;
      try {
        await apiCall(`/bookings/${id}`, 'DELETE');
        loadBookings();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    // Car Companies
    async function loadCarCompanies() {
      try {
        const data = await apiCall('/car-companies');
        if (data.success) {
          carCompaniesData = data.data;
          renderCarCompanies();
        }
      } catch (err) {
        console.error('Error loading car companies:', err);
      }
    }

    function renderCarCompanies() {
      const tbody = document.getElementById('car-companies-table');
      if (carCompaniesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ยังไม่มีบริษัทรถ</td></tr>';
        return;
      }
      
      tbody.innerHTML = carCompaniesData.map(c => {
        let regions = '-';
        try { regions = c.regions_served ? JSON.parse(c.regions_served).join(', ') : '-'; } catch {}
        return `
          <tr>
            <td><strong>${c.name}</strong></td>
            <td>${c.contact_name || '-'}</td>
            <td>${c.phone || '-'}</td>
            <td>${c.line_id || '-'}</td>
            <td>${regions}</td>
            <td>
              <button class="action-btn" onclick="deleteCarCompany(${c.id})">ลบ</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openCarCompanyModal() {
      document.getElementById('company-name').value = '';
      document.getElementById('company-contact').value = '';
      document.getElementById('company-phone').value = '';
      document.getElementById('company-email').value = '';
      document.getElementById('company-line').value = '';
      document.getElementById('company-notes').value = '';
      document.getElementById('car-company-modal').classList.add('active');
    }

    async function saveCarCompany(e) {
      e.preventDefault();
      const data = {
        name: document.getElementById('company-name').value,
        contact_name: document.getElementById('company-contact').value,
        phone: document.getElementById('company-phone').value,
        email: document.getElementById('company-email').value,
        line_id: document.getElementById('company-line').value,
        notes: document.getElementById('company-notes').value
      };
      
      try {
        await apiCall('/car-companies', 'POST', data);
        closeModal('car-company-modal');
        loadCarCompanies();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    async function deleteCarCompany(id) {
      if (!confirm('ต้องการลบบริษัทรถนี้?')) return;
      // Note: Would need to add delete endpoint for car companies
      alert('ฟีเจอร์นี้ยังไม่พร้อมใช้งาน');
    }

    // Payments
    async function loadPayments() {
      try {
        const data = await apiCall('/payments');
        if (data.success) {
          paymentsData = data.data;
          renderPayments();
        }
      } catch (err) {
        console.error('Error loading payments:', err);
      }
    }

    function renderPayments() {
      const tbody = document.getElementById('payments-table');
      if (paymentsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ยังไม่มีการชำระเงิน</td></tr>';
        return;
      }
      
      tbody.innerHTML = paymentsData.map(p => `
        <tr>
          <td><strong>${p.booking_code || '-'}</strong></td>
          <td>${p.customer_name || '-'}</td>
          <td><span class="status-badge status-${p.payment_type}">${getPaymentTypeText(p.payment_type)}</span></td>
          <td>${formatCurrency(p.amount)} ${p.currency || 'THB'}</td>
          <td>${getPaymentMethodText(p.payment_method)}</td>
          <td>${formatDate(p.paid_at)}</td>
          <td>${p.slip_url ? '<a href="' + p.slip_url + '" target="_blank" class="action-btn">ดูสลิป</a>' : '-'}</td>
          <td>${p.verified_at ? '<span style="color:var(--success)">✓ ตรวจแล้ว</span>' : '<span style="color:var(--warning)">รอตรวจ</span>'}</td>
          <td>
            <button class="action-btn" onclick="verifyPayment(${p.id})">ตรวจสอบ</button>
            <button class="action-btn" onclick="deletePayment(${p.id})">ลบ</button>
          </td>
        </tr>
      `).join('');
    }

    async function openPaymentModal(payment = null) {
      // Load bookings for dropdown
      if (bookingsData.length === 0) {
        const data = await apiCall('/bookings');
        if (data.success) bookingsData = data.data;
      }
      
      const select = document.getElementById('payment-booking');
      select.innerHTML = '<option value="">-- เลือกการจอง --</option>' + 
        bookingsData.map(b => `<option value="${b.id}">${b.booking_code} - ${b.customer_name || 'ไม่ระบุ'}</option>`).join('');
      
      document.getElementById('payment-modal-title').textContent = payment ? 'แก้ไขการชำระเงิน' : 'บันทึกการชำระเงิน';
      document.getElementById('payment-id').value = payment?.id || '';
      document.getElementById('payment-booking').value = payment?.booking_id || '';
      document.getElementById('payment-type').value = payment?.payment_type || 'deposit';
      document.getElementById('payment-amount').value = payment?.amount || '';
      document.getElementById('payment-currency').value = payment?.currency || 'THB';
      document.getElementById('payment-method').value = payment?.payment_method || '';
      document.getElementById('payment-date').value = payment?.paid_at || new Date().toISOString().split('T')[0];
      document.getElementById('payment-reference').value = payment?.reference_no || '';
      document.getElementById('payment-notes').value = payment?.notes || '';
      document.getElementById('slip-preview').innerHTML = payment?.slip_url ? 
        `<img src="${payment.slip_url}" style="max-width:200px;max-height:150px;border-radius:8px;">` : '';
      uploadedSlipUrl = payment?.slip_url || null;
      
      document.getElementById('payment-modal').classList.add('active');
    }

    function previewSlip(input) {
      const preview = document.getElementById('slip-preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" style="max-width:200px;max-height:150px;border-radius:8px;">`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function uploadSlip(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('folder', 'slips');
      
      const res = await fetch(`${API_BASE}/upload`, {
        method: 'POST',
        body: formData
      });
      return res.json();
    }

    async function savePayment(e) {
      e.preventDefault();
      const submitBtn = document.getElementById('payment-submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'กำลังบันทึก...';
      
      try {
        // Upload slip if selected
        const slipInput = document.getElementById('payment-slip');
        let slipUrl = uploadedSlipUrl;
        
        if (slipInput.files && slipInput.files[0]) {
          const uploadResult = await uploadSlip(slipInput.files[0]);
          if (uploadResult.success) {
            slipUrl = uploadResult.url;
          } else {
            throw new Error('อัพโหลดสลิปไม่สำเร็จ: ' + uploadResult.error);
          }
        }
        
        const id = document.getElementById('payment-id').value;
        const data = {
          booking_id: parseInt(document.getElementById('payment-booking').value),
          payment_type: document.getElementById('payment-type').value,
          amount: parseFloat(document.getElementById('payment-amount').value),
          currency: document.getElementById('payment-currency').value,
          payment_method: document.getElementById('payment-method').value || null,
          paid_at: document.getElementById('payment-date').value || null,
          reference_no: document.getElementById('payment-reference').value || null,
          slip_url: slipUrl,
          notes: document.getElementById('payment-notes').value || null
        };
        
        if (id) {
          await apiCall(`/payments/${id}`, 'PUT', data);
        } else {
          await apiCall('/payments', 'POST', data);
        }
        
        closeModal('payment-modal');
        loadPayments();
        // Reset form
        document.getElementById('payment-slip').value = '';
        uploadedSlipUrl = null;
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'บันทึก';
      }
    }

    async function verifyPayment(id) {
      if (!confirm('ยืนยันว่าตรวจสอบการชำระเงินนี้แล้ว?')) return;
      try {
        await apiCall(`/payments/${id}`, 'PUT', {
          verified_at: new Date().toISOString()
        });
        loadPayments();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    async function deletePayment(id) {
      if (!confirm('ต้องการลบการชำระเงินนี้?')) return;
      try {
        await apiCall(`/payments/${id}`, 'DELETE');
        loadPayments();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    function getPaymentTypeText(type) {
      const map = {
        'deposit': 'มัดจำ',
        'partial': 'ชำระบางส่วน',
        'full': 'ชำระเต็ม',
        'refund': 'คืนเงิน'
      };
      return map[type] || type;
    }

    function getPaymentMethodText(method) {
      const map = {
        'transfer': 'โอนเงิน',
        'cash': 'เงินสด',
        'credit': 'บัตรเครดิต',
        'promptpay': 'PromptPay'
      };
      return map[method] || method || '-';
    }

    // Car Bookings
    let carBookingsData = [];
    let carCompaniesData = [];

    async function loadCarBookings() {
      try {
        // Load car companies if needed
        if (carCompaniesData.length === 0) {
          const compData = await apiCall('/car-companies');
          if (compData.success) carCompaniesData = compData.data;
        }
        
        const data = await apiCall('/car-bookings');
        if (data.success) {
          carBookingsData = data.data;
          renderCarBookings();
          updateCarBookingFilter();
          updateCarBookingSummary();
        }
      } catch (err) {
        console.error('Error loading car bookings:', err);
        document.getElementById('car-bookings-table').innerHTML = 
          '<tr><td colspan="9" class="empty-state">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
      }
    }

    function updateCarBookingFilter() {
      const select = document.getElementById('car-booking-filter');
      const currentValue = select.value;
      
      // Get unique bookings
      const uniqueBookings = [...new Map(carBookingsData.map(cb => [cb.booking_id, {
        id: cb.booking_id,
        code: cb.booking_code,
        customer: cb.customer_name
      }])).values()];
      
      select.innerHTML = '<option value="">-- แสดงทั้งหมด --</option>' +
        uniqueBookings.map(b => `<option value="${b.id}">${b.code} - ${b.customer || 'ไม่ระบุ'}</option>`).join('');
      
      select.value = currentValue;
    }

    function filterCarBookings() {
      renderCarBookings();
      updateCarBookingSummary();
    }

    function renderCarBookings() {
      const tbody = document.getElementById('car-bookings-table');
      const filterValue = document.getElementById('car-booking-filter').value;
      
      let filtered = carBookingsData;
      if (filterValue) {
        filtered = carBookingsData.filter(cb => cb.booking_id == filterValue);
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ไม่มีรายการจองรถ</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(cb => `
        <tr>
          <td><strong>${cb.booking_code || '-'}</strong></td>
          <td>${formatDate(cb.service_date)}</td>
          <td><span class="status-badge status-${cb.service_type?.toLowerCase()}">${cb.service_type || '-'}</span></td>
          <td>${cb.vehicle_type || '-'}</td>
          <td>
            ${cb.pickup_time ? '<strong>' + cb.pickup_time + '</strong><br>' : ''}
            ${cb.pickup_location || '-'}
            ${cb.dropoff_location ? ' → ' + cb.dropoff_location : ''}
          </td>
          <td>${cb.company_name || '-'}</td>
          <td>
            ${cb.confirmed_price ? '<strong>¥' + formatCurrency(cb.confirmed_price) + '</strong>' : 
              (cb.quoted_price ? '¥' + formatCurrency(cb.quoted_price) + ' (ราคาเสนอ)' : '-')}
          </td>
          <td><span class="status-badge status-${cb.status}">${getCarBookingStatusText(cb.status)}</span></td>
          <td>
            <button class="action-btn" onclick="editCarBooking(${cb.id})">แก้ไข</button>
            <button class="action-btn" onclick="deleteCarBooking(${cb.id})">ลบ</button>
          </td>
        </tr>
      `).join('');
    }

    function updateCarBookingSummary() {
      const filterValue = document.getElementById('car-booking-filter').value;
      const summaryCard = document.getElementById('car-booking-summary');
      const summaryContent = document.getElementById('car-booking-summary-content');
      
      if (!filterValue) {
        summaryCard.style.display = 'none';
        return;
      }
      
      const filtered = carBookingsData.filter(cb => cb.booking_id == filterValue);
      const totalQuoted = filtered.reduce((sum, cb) => sum + (cb.quoted_price || 0), 0);
      const totalConfirmed = filtered.reduce((sum, cb) => sum + (cb.confirmed_price || 0), 0);
      const confirmedCount = filtered.filter(cb => cb.status === 'confirmed' || cb.status === 'completed').length;
      
      summaryCard.style.display = 'block';
      summaryContent.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;">
          <div>
            <div style="font-size:12px;color:var(--text-muted)">จำนวนวัน</div>
            <div style="font-size:24px;font-weight:600">${filtered.length}</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--text-muted)">ยืนยันแล้ว</div>
            <div style="font-size:24px;font-weight:600;color:var(--success)">${confirmedCount}/${filtered.length}</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--text-muted)">ราคาเสนอรวม</div>
            <div style="font-size:24px;font-weight:600">¥${formatCurrency(totalQuoted)}</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--text-muted)">ราคาตกลงรวม</div>
            <div style="font-size:24px;font-weight:600;color:var(--primary)">¥${formatCurrency(totalConfirmed)}</div>
          </div>
        </div>
      `;
    }

    async function openCarBookingModal(carBooking = null) {
      // Load bookings for dropdown
      if (bookingsData.length === 0) {
        const data = await apiCall('/bookings');
        if (data.success) bookingsData = data.data;
      }
      
      // Load car companies for dropdown
      if (carCompaniesData.length === 0) {
        const data = await apiCall('/car-companies');
        if (data.success) carCompaniesData = data.data;
      }
      
      const bookingSelect = document.getElementById('car-booking-booking');
      bookingSelect.innerHTML = '<option value="">-- เลือกการจอง --</option>' + 
        bookingsData.map(b => `<option value="${b.id}">${b.booking_code} - ${b.customer_name || 'ไม่ระบุ'} (${formatDate(b.travel_start_date)})</option>`).join('');
      
      const companySelect = document.getElementById('car-booking-company');
      companySelect.innerHTML = '<option value="">-- เลือก --</option>' + 
        carCompaniesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      
      document.getElementById('car-booking-modal-title').textContent = carBooking ? 'แก้ไขรายการจองรถ' : 'เพิ่มรายการจองรถ';
      document.getElementById('car-booking-id').value = carBooking?.id || '';
      document.getElementById('car-booking-booking').value = carBooking?.booking_id || '';
      document.getElementById('car-booking-date').value = carBooking?.service_date || '';
      document.getElementById('car-booking-type').value = carBooking?.service_type || 'Charter';
      document.getElementById('car-booking-vehicle').value = carBooking?.vehicle_type || '';
      document.getElementById('car-booking-company').value = carBooking?.car_company_id || '';
      document.getElementById('car-booking-pickup-time').value = carBooking?.pickup_time || '';
      document.getElementById('car-booking-pickup-loc').value = carBooking?.pickup_location || '';
      document.getElementById('car-booking-dropoff-loc').value = carBooking?.dropoff_location || '';
      document.getElementById('car-booking-quoted').value = carBooking?.quoted_price || '';
      document.getElementById('car-booking-confirmed').value = carBooking?.confirmed_price || '';
      document.getElementById('car-booking-driver-name').value = carBooking?.driver_name || '';
      document.getElementById('car-booking-driver-phone').value = carBooking?.driver_phone || '';
      document.getElementById('car-booking-status').value = carBooking?.status || 'pending';
      document.getElementById('car-booking-notes').value = carBooking?.notes || '';
      
      document.getElementById('car-booking-modal').classList.add('active');
    }

    function editCarBooking(id) {
      const carBooking = carBookingsData.find(cb => cb.id === id);
      if (carBooking) openCarBookingModal(carBooking);
    }

    async function saveCarBooking(e) {
      e.preventDefault();
      const id = document.getElementById('car-booking-id').value;
      const data = {
        booking_id: parseInt(document.getElementById('car-booking-booking').value),
        service_date: document.getElementById('car-booking-date').value,
        service_type: document.getElementById('car-booking-type').value,
        vehicle_type: document.getElementById('car-booking-vehicle').value || null,
        car_company_id: document.getElementById('car-booking-company').value ? parseInt(document.getElementById('car-booking-company').value) : null,
        pickup_time: document.getElementById('car-booking-pickup-time').value || null,
        pickup_location: document.getElementById('car-booking-pickup-loc').value || null,
        dropoff_location: document.getElementById('car-booking-dropoff-loc').value || null,
        quoted_price: document.getElementById('car-booking-quoted').value ? parseFloat(document.getElementById('car-booking-quoted').value) : null,
        confirmed_price: document.getElementById('car-booking-confirmed').value ? parseFloat(document.getElementById('car-booking-confirmed').value) : null,
        driver_name: document.getElementById('car-booking-driver-name').value || null,
        driver_phone: document.getElementById('car-booking-driver-phone').value || null,
        status: document.getElementById('car-booking-status').value,
        notes: document.getElementById('car-booking-notes').value || null
      };
      
      try {
        if (id) {
          await apiCall(`/car-bookings/${id}`, 'PUT', data);
        } else {
          await apiCall('/car-bookings', 'POST', data);
        }
        closeModal('car-booking-modal');
        loadCarBookings();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    async function deleteCarBooking(id) {
      if (!confirm('ต้องการลบรายการจองรถนี้?')) return;
      try {
        await apiCall(`/car-bookings/${id}`, 'DELETE');
        loadCarBookings();
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);
      }
    }

    function getCarBookingStatusText(status) {
      const map = {
        'pending': 'รอยืนยัน',
        'quoted': 'ได้ราคาแล้ว',
        'confirmed': 'ยืนยันแล้ว',
        'completed': 'เสร็จสิ้น',
        'cancelled': 'ยกเลิก'
      };
      return map[status] || status;
    }

    // Utilities
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
    }

    function formatCurrency(num) {
      if (!num) return '-';
      return new Intl.NumberFormat('th-TH').format(num);
    }

    function getStatusText(status) {
      const map = {
        'inquiry': 'สอบถาม',
        'confirmed': 'ยืนยันแล้ว',
        'paid': 'ชำระแล้ว',
        'completed': 'เสร็จสิ้น',
        'cancelled': 'ยกเลิก'
      };
      return map[status] || status;
    }

    // Initialize
    loadDashboard();
  </script>
</body>
</html>

